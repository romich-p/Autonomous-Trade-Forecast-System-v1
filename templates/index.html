from flask import Flask, request, jsonify, send_file, render_template
from core.data_store import store_candle, store_signal
from core.plotter import plot_chart

app = Flask(__name__)

@app.route('/')
def index():
    return render_template('index.html')

@app.route('/plot')
def plot():
    ticker = request.args.get("ticker", "GBPUSD")
    timeframe = request.args.get("timeframe", "15S")
    path = plot_chart(ticker, timeframe)
    if path:
        return send_file(path, mimetype="image/png")
    else:
        return f"No data for {ticker} {timeframe}", 404

@app.route('/webhook', methods=["POST"])
def webhook():
    data = request.json
    app.logger.info(f"Received JSON: {data}")

    event_type = data.get("event")

    try:
        if event_type == "candle":
            store_candle(data)
        elif event_type == "signal":
            data.setdefault("time", request.headers.get("X-Time") or "")
            store_signal(data, advanced=False)
        elif event_type == "signal_advanced":
            data.setdefault("time", request.headers.get("X-Time") or "")
            store_signal(data, advanced=True)
        return jsonify({"status": "ok"})
    except Exception as e:
        app.logger.error(f"Error: {e}")
        return jsonify({"status": "error", "detail": str(e)}), 500

if __name__ == "__main__":
    app.run(host="0.0.0.0", port=10000)
